<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>EAFTIMOS</title>

    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon_io/eaf_white-outline.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon_io/eaf_white-outline.png">
    <link rel="manifest" href="assets/images/favicon_io/site.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/favicon_io/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/images/favicon_io/android-chrome-512x512.png">

    <meta name="description"
        content="An inner house where silence, craft, and the avant-garde meet. Join to receive your access key and early access to releases and updates.">
    <meta name="keywords"
        content="Eaftimos, fashion brand, lifestyle brand, exclusive clothing, premium apparel, streetwear, minimal design, modern fashion, unisex fashion, luxury clothing, belonging, individuality">

    <!-- Preload critical fonts -->
    <link rel="preload" href="assets/fonts/Helvetica.ttf" as="font" type="font/ttf" crossorigin>

    <!-- Preload critical CSS -->
    <link rel="stylesheet" href="assets/css/style.css?v=20260208">

    <!-- DNS prefetch for faster resource loading -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
</head>

<body class="canvas-body index-page">
    <!-- PRELOADER -->
    <div id="preloader" class="preloader" style="z-index:1000; position:fixed; inset:0; background:#fff;">
        <div class="preloader-content preloader-sober">
            <!-- Logo de la marca -->
            <div class="preloader-logo">
                <img src="assets/images/logo.png" alt="Eaftimos Logo" id="sharedLogoPreloader" width="150" height="auto"
                    draggable="false" style="display:block; max-width: 150px;" />
            </div>
            <div class="preloader-bar-container">
                <div class="preloader-bar-bg hard-corner">
                    <div class="preloader-bar hard-corner" id="preloaderBar"></div>
                </div>
                <span class="preloader-bar-text" id="preloaderBarText">0%</span>
            </div>
            <div class="preloader-toggles-bottom">
                <div class="sidebar-control-buttons">
                    <button class="sidebar-control-btn" id="preloaderVisualToggle" title="Toggle Visual Effects">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle class="eye-open" cx="12" cy="12" r="3"></circle>
                            <line class="eye-closed" style="display:none;" x1="1" y1="1" x2="23" y2="23"
                                stroke-linecap="round"></line>
                        </svg>
                    </button>
                    <button class="sidebar-control-btn" id="preloaderSoundToggle" title="Toggle Audio">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path class="speaker-on" d="M3 9v6c0 1.105.895 2 2 2h4l5 5V4H9c-1.105 0-2 .895-2 2v3z">
                            </path>
                            <path class="speaker-on" d="M17.5 3.5a4 4 0 0 1 0 5.66M19.07 4.93a8 8 0 0 1 0 11.31"></path>
                            <path class="speaker-off" style="display:none;" d="M11 5L6 9H2v6h4l5 5V5z"></path>
                            <line class="speaker-off" style="display:none;" x1="23" y1="9" x2="17" y2="15"></line>
                            <line class="speaker-off" style="display:none;" x1="17" y1="9" x2="23" y2="15"></line>
                        </svg>
                    </button>
                </div>
                <span class="control-status-message" id="preloaderNotification"></span>
            </div>
            <button id="preloaderEnterBtn" class="preloader-enter-btn hard-corner" disabled
                style="display:none;">Enter</button>
        </div>
    </div>
    <!-- Grain Canvas -->
    <canvas id="grainCanvas" style="visibility:hidden;"></canvas>

    <!-- Background Video TOP -->
    <div id="videos-background" style="visibility:hidden;">
        <!-- Video de fondo principal -->
        <video autoplay muted loop playsinline preload="auto">
            <source src="assets/vid/reels-mixed-vid.mp4" type="video/mp4">
        </video>

        <!-- Overlay de video con transparencia y blend mode 
        <video id="stormlight-overlay" autoplay muted loop playsinline preload="auto" style="opacity:0.5;mix-blend-mode:screen;pointer-events:none;">
            <source src="assets/vid/visualizer/light-leak-orange.mp4" type="video/mp4">   
        </video> -->
    </div>

    <nav class="blending-item">
        <div class="nav-container">
            <!-- Menu Hamburguesa -->
            <div class="menu-toggle" id="menuToggle"
                style="opacity:0; pointer-events:none; transition:opacity 0.7s cubic-bezier(.77,0,.18,1);">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <!-- Logo compartido con preloader -->
            <a href="index.html" class="logo shared-logo" data-shape="circle">
                <img src="assets/images/logo-white.png" alt="Eaftimos Logo" id="sharedLogo" width="150" height="auto"
                    draggable="false">
            </a>
        </div>

        <!-- Menú Desplegable -->
        <div class="dropdown-menu" id="dropdownMenu">
            <div class="menu-links">
                <a href="https://shop.eaftimos.com/" target="_blank" rel="noopener noreferrer"
                    class="dropdown-link" data-shape="circle">SHOP</a>
                <div class="dropdown-item-with-submenu" style="display:none;">
                    <button class="dropdown-link dropdown-toggle" id="collectionsToggle">
                        COLLECTIONS
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" width="16" height="16" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div class="submenu" id="collectionsSubmenu">
                        <a href="#nierika" class="submenu-link">NIERIKA AW26</a>
                        <a href="gallery-view.html" class="submenu-link">RESiLiENCE AW24</a>
                    </div>
                </div>
                <div class="dropdown-item-with-submenu">
                    <button class="dropdown-link dropdown-toggle" id="socialMediaToggle">
                        SOCIAL MEDIA
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" width="16" height="16" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div class="submenu" id="socialMediaSubmenu">
                        <a href="https://www.instagram.com/eaftimos/" target="_blank" rel="noopener noreferrer" class="submenu-link">INSTAGRAM</a>
                        <a href="https://www.tiktok.com/@eaftimos" target="_blank" rel="noopener noreferrer" class="submenu-link">TIKTOK</a>
                    </div>
                </div>
                <button class="dropdown-link" id="contactBtn" data-shape="circle">CONTACT</button>
            </div>

            <!-- Control Icons in Sidebar -->
            <div class="sidebar-controls">
                <div class="sidebar-control-buttons">
                    <button class="sidebar-control-btn" id="visualToggle" title="Toggle Visual Effects">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <!-- Icono de ojo abierto -->
                            <path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle class="eye-open" cx="12" cy="12" r="3"></circle>
                            <!-- Icono de ojo cerrado (oculto inicialmente) -->
                            <line class="eye-closed" style="display:none;" x1="1" y1="1" x2="23" y2="23"
                                stroke-linecap="round"></line>
                        </svg>
                    </button>
                    <button class="sidebar-control-btn" id="audioToggle" title="Toggle Audio">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <!-- Altavoz abierto -->
                            <path class="speaker-on" d="M3 9v6c0 1.105.895 2 2 2h4l5 5V4H9c-1.105 0-2 .895-2 2v3z">
                            </path>
                            <path class="speaker-on" d="M17.5 3.5a4 4 0 0 1 0 5.66M19.07 4.93a8 8 0 0 1 0 11.31"></path>
                            <!-- Altavoz mudo (oculto inicialmente) -->
                            <path class="speaker-off" style="display:none;" d="M11 5L6 9H2v6h4l5 5V5z"></path>
                            <line class="speaker-off" style="display:none;" x1="23" y1="9" x2="17" y2="15"></line>
                            <line class="speaker-off" style="display:none;" x1="17" y1="9" x2="23" y2="15"></line>
                        </svg>
                    </button>
                </div>
                <div class="control-status-message" id="statusMessage"></div>
            </div>
        </div>
    </nav>

    <!-- Contact Form Modal -->
    <div class="contact-modal" id="contactModal">
        <div class="contact-modal-content">
            <button class="contact-close" id="contactClose" data-shape="circle">&times;</button>
            <h2>CONTACT US</h2>
            <form id="contactForm" action="https://formsubmit.co/beastnirvana.csn@gmail.com" method="POST">
                <!-- FormSubmit Configuration -->
                <input type="hidden" name="_subject" value="New contact from Eftimos">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                
                <div class="form-group">
                    <input type="text" id="name" name="name" placeholder="NAME" required data-shape="cross">
                </div>
                <div class="form-group">
                    <input type="email" id="email" name="email" placeholder="EMAIL" required data-shape="cross">
                </div>
                <div class="form-group">
                    <select id="queryType" name="queryType" required data-shape="cross">
                        <option value="" disabled selected>TIPO DE CONSULTA</option>
                        <option value="Ropa a medida">Ropa a medida</option>
                        <option value="Estilismo">Estilismo</option>
                        <option value="Prensa">Prensa</option>
                        <option value="Redes sociales">Redes sociales</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <textarea id="message" name="message" placeholder="MESSAGE" rows="5" required data-shape="cross"></textarea>
                </div>
                <button type="submit" class="submit-btn" data-shape="circle">SEND</button>
            </form>
        </div>
    </div>

    <div id="canvas"></div>

    <div id="image-templates" style="display: none;">
        <!-- Todos los elementos del mapa llevan a clothes-view.html -->
        <div class="image-template initial-center">
            <a href="team.html" class="image-link" data-sound="team" data-shape="circle">
                <img src="assets/images/g-6.webp" alt="TEAM" width="170" height="170">
                <span class="tooltip">TEAM</span>
            </a>
        </div>
        <div class="image-template">
            <a href="origin.html" class="image-link" data-sound="origin" data-shape="circle">
                <img src="assets/images/origin-page/origin-n5.JPG" alt="Fashion Mountain Collection" loading="lazy"
                    width="170" height="170">
                <span class="tooltip">ORIGIN</span>
            </a>
        </div>
        <div class="image-template">
            <a href="atelier.html" class="image-link" data-sound="atelier" data-shape="circle">
                <img src="assets/images/g-5.webp" alt="Fashion Collection Winter" loading="lazy" width="170"
                    height="170">
                <span class="tooltip">ATELIER</span>
            </a>
        </div>
        <div class="image-template">
            <a href="gallery-view.html" class="image-link" data-sound="resilience" data-shape="circle">
                <img src="assets/images/g-2.webp" alt="Fashion Nature Collection" loading="lazy" width="170"
                    height="170">
                <span class="tooltip">RESiLiENCE AW24 COLLECTION</span>
            </a>
        </div>
        <div class="image-template">
            <a href="bts.html" class="image-link" data-sound="bts" data-shape="circle">
                <img src="assets/images/bts-resiliance/eaftimosbts1499.jpg" alt="Behind The Scenes" loading="lazy"
                    width="170" height="170">
                <span class="tooltip">RESiLiENCE AW24 BTS</span>
            </a>
        </div>
        <div class="image-template reveal-text-template" data-text="DISCOVER THE SECRETS"
            data-sound="locked-in-oneself">
            <div class="reveal-text-container">
                <canvas class="reveal-text-canvas"></canvas>
            </div>
        </div>
        <div class="image-template">
            <a href="about-us.html" class="image-link" data-sound="vision" data-shape="circle">
                <img src="assets/images/vision-page/vision-n3.jpg" alt="Fashion Winter Collection" loading="lazy"
                    width="170" height="170">
                <span class="tooltip">VISION</span>
            </a>
        </div>
        <div class="image-template">
            <a href="press.html" class="image-link" data-sound="press" data-shape="circle">
                <img src="assets/images/press-page/press-gallery-5.jpeg" alt="Fashion Winter Collection" loading="lazy"
                    width="170" height="170">
                <span class="tooltip">PRESS</span>
            </a>
        </div>
        <div class="image-template">
            <div class="video-link" data-sound="locked-in-oneself" data-shape="circle">
                <video autoplay muted loop playsinline width="180" height="320" preload="metadata">
                    <source src="assets/vid/reels-mixed-vid.mp4" type="video/mp4">
                </video>
                <span class="tooltip">Preview Reel</span>
            </div>
        </div>
    </div>

    <!-- Sonidos -->
    <audio id="noiseSound" src="assets/sounds/white-noise.mp3" preload="auto" loop></audio>
    <audio id="whispersSound" src="assets/sounds/whispers.mp3" preload="auto" loop></audio>
    <audio id="lockedInSound" src="assets/sounds/locked-in-oneself.mp3" preload="auto"></audio>

    <!-- Load scripts with defer for better performance -->
    <script defer src="assets/js/performance-monitor.js"></script>
    <script defer src="assets/js/ui-sounds.js"></script>
    <script defer src="assets/js/script.js"></script>

    <!-- Darken video on map item hover -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('canvas');
            const videosBackground = document.getElementById('videos-background');
            if (!canvas || !videosBackground) return;

            canvas.addEventListener('mouseenter', function(e) {
                const mapItem = e.target.closest('.image-link, .video-link');
                if (mapItem) videosBackground.classList.add('map-item-hovered');
            }, true);

            canvas.addEventListener('mouseleave', function(e) {
                const mapItem = e.target.closest('.image-link, .video-link');
                if (mapItem) videosBackground.classList.remove('map-item-hovered');
            }, true);

            canvas.addEventListener('mouseover', function(e) {
                const mapItem = e.target.closest('.image-link, .video-link');
                if (mapItem) {
                    videosBackground.classList.add('map-item-hovered');
                } else {
                    videosBackground.classList.remove('map-item-hovered');
                }
            });
        });
    </script>
    <script defer src="assets/js/controls.js?v=20260205"></script>
    <script defer src="assets/js/handheld-camera.js"></script>
    <script defer src="assets/js/cursor-effect.js"></script>
    <script defer src="assets/js/grain-effect.js?v=20260206"></script>
    <script defer src="assets/js/tooltip-nebula.js"></script>
    <script defer src="assets/js/contact-nebula.js"></script>
    <script defer src="assets/js/perspective-distortion.js"></script>
    <script defer src="assets/js/reveal-text.js"></script>

    <script>
        (function () {
            // --- WHISPERS SOUND LOGIC ---
            const whispersSound = document.getElementById('whispersSound');
            if (whispersSound) {
                const BASE_VOLUME = 0.04;
                const HOVER_VOLUME = 0.10;
                const TRANSITION_STEPS = 20;
                let isPlaying = false;
                let volumeTransitionInterval = null;
                let volumeMonitorInterval = null;
                let targetVolume = BASE_VOLUME;
                let canPlayAudio = false; // No reproducir hasta que el preloader termine

                function smoothVolumeTransition(target, duration = 300) {
                    if (volumeTransitionInterval) {
                        clearInterval(volumeTransitionInterval);
                    }
                    const startVolume = whispersSound.volume;
                    const volumeDiff = target - startVolume;
                    const stepDuration = duration / TRANSITION_STEPS;
                    let currentStep = 0;
                    volumeTransitionInterval = setInterval(() => {
                        currentStep++;
                        const progress = currentStep / TRANSITION_STEPS;
                        const easeProgress = progress < 0.5
                            ? 2 * progress * progress
                            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                        whispersSound.volume = startVolume + (volumeDiff * easeProgress);
                        if (currentStep >= TRANSITION_STEPS) {
                            clearInterval(volumeTransitionInterval);
                            volumeTransitionInterval = null;
                            whispersSound.volume = target;
                            targetVolume = target;
                        }
                    }, stepDuration);
                }
                function startWhispers() {
                    if (isPlaying || !canPlayAudio) return; // Solo si el preloader terminó
                    whispersSound.volume = BASE_VOLUME;
                    whispersSound.muted = false;
                    targetVolume = BASE_VOLUME;
                    whispersSound.play().then(() => {
                        isPlaying = true;
                        volumeMonitorInterval = setInterval(() => {
                            if (isPlaying && !volumeTransitionInterval && whispersSound.volume !== targetVolume) {
                                whispersSound.volume = targetVolume;
                            }
                        }, 100);
                    }).catch(() => { });
                }

                // Escuchar cuando el preloader termine
                window.addEventListener('preloaderFinished', () => {
                    canPlayAudio = true;
                    console.log('[AUDIO] Preloader finished');
                    // El audio ya fue iniciado en el click del botón Enter
                });

                window.addEventListener('tooltipShown', () => {
                    if (canPlayAudio) smoothVolumeTransition(HOVER_VOLUME, 400);
                });
                window.addEventListener('tooltipHidden', () => {
                    if (canPlayAudio) smoothVolumeTransition(BASE_VOLUME, 500);
                });
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.image-link') && isPlaying) {
                        smoothVolumeTransition(0, 400);
                    }
                });
            }

            // --- AUDIO RELIABILITY SYSTEM ---
            // El audio se inicia directamente en el click del botón Enter del preloader
            // No se necesitan funciones adicionales de inicialización

            // --- BFCACHE / BACK BUTTON RESTORATION ---
            // Cuando el usuario vuelve con el botón Back del móvil, el navegador puede
            // restaurar la página desde bfcache. En ese caso el evento 'load' NO se dispara,
            // y la clase 'unloading' (opacity:0) sigue aplicada → pantalla blanca.
            window.addEventListener('pageshow', function (e) {
                // e.persisted = true cuando viene de bfcache, pero también
                // queremos restaurar en navegación normal de vuelta
                if (e.persisted || document.body.classList.contains('unloading')) {
                    console.log('[PAGESHOW] Restaurando página tras navegación back (persisted:', e.persisted, ')');
                    
                    // 1. Quitar la clase unloading que pone opacity:0 en body
                    document.body.classList.remove('unloading');
                    
                    // 2. Forzar opacity visible en body por si la animación fadeIn no se repite
                    document.body.style.opacity = '1';
                    
                    // 3. Asegurar que el fondo sea visible
                    var videosBackground = document.getElementById('videos-background');
                    var grainCanvas = document.getElementById('grainCanvas');
                    if (videosBackground) videosBackground.style.visibility = '';
                    if (grainCanvas) grainCanvas.style.visibility = '';
                    
                    // 4. Asegurar que el preloader esté oculto (si ya fue mostrado)
                    if (localStorage.getItem('eftimosPreloaderShown') === '1') {
                        var preloaderEl = document.getElementById('preloader');
                        if (preloaderEl) {
                            preloaderEl.style.display = 'none';
                            preloaderEl.style.visibility = 'hidden';
                            preloaderEl.style.opacity = '0';
                            preloaderEl.style.pointerEvents = 'none';
                        }
                        document.body.classList.remove('preloader-active');
                    }
                    
                    // 5. Asegurar que la hamburguesa y el logo estén visibles
                    var menuToggle = document.getElementById('menuToggle');
                    var sharedLogo = document.getElementById('sharedLogo');
                    if (menuToggle) {
                        menuToggle.style.opacity = '1';
                        menuToggle.style.pointerEvents = 'auto';
                    }
                    if (sharedLogo) {
                        sharedLogo.style.opacity = '1';
                    }
                    
                    // 6. Reanudar video de fondo si estaba pausado
                    if (videosBackground) {
                        var bgVideos = videosBackground.querySelectorAll('video');
                        bgVideos.forEach(function(v) {
                            if (v.paused) {
                                v.play().catch(function() {});
                            }
                        });
                    }
                    
                    // 7. Reanudar animación de grano si está habilitada
                    var visualEnabled = localStorage.getItem('visualEffectsEnabled') !== 'false';
                    if (visualEnabled && typeof window.startGrainAnimation === 'function') {
                        window.startGrainAnimation();
                    }
                }
            });

            // --- PRELOADER FADE LOGIC ---
            function showBackground() {
                document.getElementById('videos-background').style.visibility = '';
                document.getElementById('grainCanvas').style.visibility = '';
            }
            function fadeOutPreloader() {
                const preloader = document.getElementById('preloader');
                preloader.style.transition = 'opacity 0.4s cubic-bezier(0.4, 0, 1, 1)';
                preloader.style.opacity = '0';
                setTimeout(() => {
                    preloader.style.display = 'none';
                }, 450);
            }
            // Mostrar fondo al cargar, pero mantener preloader visible
            window.addEventListener('load', function () {
                setTimeout(() => {
                    showBackground();

                    // Verificar si el preloader ya fue mostrado antes
                    const preloaderShown = localStorage.getItem('eftimosPreloaderShown') === '1';

                    if (preloaderShown) {
                        // Si ya se mostró el preloader, marcar flag pero NO iniciar audio aún
                        // El audio se iniciará con la primera interacción del usuario
                        window.preloaderEnterPressed = true;
                        console.log('[LOAD] Preloader already shown, audio will start on first interaction');
                    } else {
                        // Mostrar el botón Enter cuando todo esté listo
                        var enterBtn = document.getElementById('preloaderEnterBtn');
                        if (enterBtn) {
                            enterBtn.disabled = false;
                            enterBtn.style.display = '';
                            enterBtn.focus();
                        }
                    }
                }, 200);
            });

            // === Función para forzar ocultación completa del preloader ===
            function forceHidePreloader(preloader) {
                if (!preloader || preloader.getAttribute('data-hidden') === '1') return;
                preloader.setAttribute('data-hidden', '1');
                preloader.style.setProperty('display', 'none', 'important');
                preloader.style.setProperty('visibility', 'hidden', 'important');
                preloader.style.setProperty('opacity', '0', 'important');
                preloader.style.setProperty('pointer-events', 'none', 'important');
                preloader.style.setProperty('z-index', '-1', 'important');
                localStorage.setItem('eftimosPreloaderShown', '1');
                try { window.dispatchEvent(new Event('preloaderFinished')); } catch(e) {}
                console.log('[PRELOADER] ✓ Preloader hidden');
            }

            // Event listener del botón Enter con animación completa
            var enterBtn = document.getElementById('preloaderEnterBtn');
            if (enterBtn) {
                function handleEnterPress() {
                    // Evitar doble ejecución
                    if (window._preloaderDismissed) return;
                    window._preloaderDismissed = true;

                    try {
                        window.preloaderEnterPressed = true;
                        var preloader = document.getElementById('preloader');
                        if (!preloader) return;

                        // === PASO 1: Desactivar interacción inmediatamente ===
                        preloader.style.pointerEvents = 'none';
                        enterBtn.disabled = true;

                        // === PASO 2: Audio (try-catch aislado) ===
                        try {
                            var soundEnabled = localStorage.getItem('audioEnabled') !== 'false';
                            if (soundEnabled) {
                                console.log('[PRELOADER] Enter pressed, initializing audio...');
                                if (typeof window.setupAudioFiltersExternal === 'function') {
                                    window.setupAudioFiltersExternal();
                                }
                                var lockedInSound = document.getElementById('lockedInSound');
                                if (lockedInSound) {
                                    lockedInSound.muted = false;
                                    lockedInSound.volume = 0.3;
                                    lockedInSound.play().catch(function() {});
                                }
                                var noiseSound = document.getElementById('noiseSound');
                                if (noiseSound) {
                                    noiseSound.muted = false;
                                    noiseSound.loop = false;
                                    noiseSound.volume = 1;
                                    noiseSound.play().then(function() {
                                        console.log('[PRELOADER] ✓ White-noise started');
                                        if (typeof window.startCrossfadeLoop === 'function' && window.noiseCrossfadeSystem) {
                                            window.startCrossfadeLoop(window.noiseCrossfadeSystem, noiseSound, true);
                                        }
                                    }).catch(function(e) {
                                        console.error('[PRELOADER] ✗ White-noise failed:', e.message);
                                    });
                                }
                                var whispersSound = document.getElementById('whispersSound');
                                if (whispersSound) {
                                    whispersSound.muted = false;
                                    whispersSound.loop = false;
                                    whispersSound.volume = 1;
                                    whispersSound.play().then(function() {
                                        console.log('[PRELOADER] ✓ Whispers started');
                                        if (typeof window.startCrossfadeLoop === 'function' && window.whispersCrossfadeSystem) {
                                            window.startCrossfadeLoop(window.whispersCrossfadeSystem, whispersSound, false);
                                        }
                                    }).catch(function(e) {
                                        console.error('[PRELOADER] ✗ Whispers failed:', e.message);
                                    });
                                }
                            }
                        } catch (audioErr) {
                            console.warn('[PRELOADER] Audio init failed (non-blocking):', audioErr);
                        }

                        // === PASO 3: Preferencias globales ===
                        window.soundEnabled = typeof soundEnabled !== 'undefined' ? soundEnabled : (localStorage.getItem('audioEnabled') !== 'false');
                        window.visualEffectsEnabled = localStorage.getItem('visualEffectsEnabled') !== 'false';
                        document.body.classList.toggle('visual-effects-disabled', !window.visualEffectsEnabled);

                        // === PASO 4: CRÍTICO iOS - Eliminar capa compositing del backdrop-filter ===
                        // En iOS Safari, backdrop-filter + will-change crea una capa GPU
                        // que NO responde a opacity:0. Debemos eliminar la clase 'loaded'
                        // (que contiene will-change y backdrop-filter) ANTES de animar.
                        preloader.classList.remove('loaded');
                        preloader.style.backdropFilter = 'none';
                        preloader.style.webkitBackdropFilter = 'none';
                        preloader.style.willChange = 'auto';
                        preloader.style.background = 'transparent';
                        // También limpiar las transitions CSS que incluyen backdrop-filter
                        preloader.style.transition = 'none';

                        // === PASO 5: Forzar reflow para que iOS procese los cambios ===
                        // Sin esto, iOS Safari puede agrupar los cambios con la animación
                        // de opacity y mantener la capa compositing activa
                        void preloader.offsetHeight;

                        // === PASO 6: Animar en el siguiente frame (después del reflow) ===
                        requestAnimationFrame(function() {
                            // Animar logo
                            var preloaderLogo = document.querySelector('.preloader-logo img');
                            if (preloaderLogo) {
                                preloaderLogo.style.position = 'relative';
                                preloaderLogo.style.zIndex = '10';
                                preloaderLogo.style.animation = 'preloaderLogoAscend 0.8s cubic-bezier(.2,.9,.2,1) forwards';
                            }

                            // Ahora sí: fade-out del preloader
                            preloader.classList.add('preloader-hide');
                            preloader.style.transition = 'opacity 0.7s cubic-bezier(.77,0,.18,1)';
                            preloader.style.opacity = '0';

                            // Mostrar hamburguesa y logo
                            var menuToggle = document.getElementById('menuToggle');
                            var sharedLogo = document.getElementById('sharedLogo');
                            if (menuToggle) {
                                menuToggle.style.opacity = '1';
                                menuToggle.style.pointerEvents = 'auto';
                            }
                            if (sharedLogo) {
                                sharedLogo.style.opacity = '1';
                                sharedLogo.style.transition = 'opacity 0.7s cubic-bezier(.77,0,.18,1)';
                            }

                            document.body.classList.remove('preloader-active');
                        });

                        // === PASO 7: Ocultar en transitionend (más fiable que setTimeout) ===
                        preloader.addEventListener('transitionend', function onTransEnd(e) {
                            if (e.propertyName === 'opacity' || e.target === preloader) {
                                preloader.removeEventListener('transitionend', onTransEnd);
                                forceHidePreloader(preloader);
                            }
                        });

                        // === PASO 8: setTimeout como respaldo ===
                        setTimeout(function() { forceHidePreloader(preloader); }, 900);

                        // === PASO 9: Fallback agresivo - si NADA funciona, forzar ===
                        setTimeout(function() {
                            var p = document.getElementById('preloader');
                            if (p && p.getAttribute('data-hidden') !== '1') {
                                console.warn('[PRELOADER] Fallback 2s: forcing hide');
                                forceHidePreloader(p);
                            }
                        }, 2000);

                    } catch (criticalErr) {
                        // Si CUALQUIER cosa falla, forzar ocultación incondicional
                        console.error('[PRELOADER] Critical error, forcing hide:', criticalErr);
                        var p = document.getElementById('preloader');
                        if (p) forceHidePreloader(p);
                        document.body.classList.remove('preloader-active');
                    }
                }

                enterBtn.addEventListener('click', handleEnterPress);
                // En iOS, touchend es más fiable que click para input inmediato
                enterBtn.addEventListener('touchend', function(e) {
                    e.preventDefault(); // Evitar que dispare click después
                    handleEnterPress();
                });
            }

            // Permitir presionar Enter desde teclado
            document.addEventListener('keydown', function (e) {
                if ((e.key === 'Enter' || e.keyCode === 13) && document.getElementById('preloader').style.opacity !== '0') {
                    var btn = document.getElementById('preloaderEnterBtn');
                    if (btn && !btn.disabled && btn.style.display !== 'none') {
                        btn.click();
                    }
                }
            });
        })();

        (function () {
            // Animación de zoom-out al volver desde otra página (estrategia con sessionStorage)
            let isAnimating = false;
            let lastAnimationTime = 0;
            
            // Detectar si es retorno: si ya visitaste index.html en esta sesión
            const sessionKey = 'eftimos_indexVisited';
            const isReturning = sessionStorage.getItem(sessionKey) === '1';
            
            console.log('[INTRO-ZOOM] isReturning:', isReturning, 'referrer:', document.referrer);

            function shouldRunIntro(eventType) {
                console.log('[INTRO-ZOOM] evento:', eventType);
                
                const now = Date.now();
                if (now - lastAnimationTime < 2000) {
                    console.log('[INTRO-ZOOM] animación muy reciente, abortando');
                    return false;
                }

                const preloaderShown = localStorage.getItem('eftimosPreloaderShown') === '1';
                const force = location.search.indexOf('introZoom=1') !== -1;
                
                if (!preloaderShown && !force) {
                    console.log('[INTRO-ZOOM] preloader no mostrado y no forzado');
                    return false;
                }

                // Si es un retorno (ya visitaste index.html en esta sesión), ejecutar SIEMPRE
                if (isReturning) {
                    console.log('[INTRO-ZOOM] detectado retorno a index.html, ejecutando animación');
                    return true;
                }

                // Si no es retorno, verificar referrer en load
                if (eventType === 'load' && (document.referrer || force)) {
                    console.log('[INTRO-ZOOM] primera visita con referrer, ejecutando');
                    return true;
                }

                console.log('[INTRO-ZOOM] condiciones no cumplidas');
                return false;
            }

            function triggerIntroZoomFromReferrer(eventType = 'manual') {
                if (isAnimating) {
                    console.log('[INTRO-ZOOM] ya hay animación en curso');
                    return;
                }

                if (!shouldRunIntro(eventType)) {
                    return;
                }

                const canvas = document.getElementById('canvas');
                if (!canvas) {
                    console.log('[INTRO-ZOOM] #canvas no encontrado');
                    return;
                }

                // Buscar el map-group dentro del canvas (donde realmente está el contenido)
                const mapGroup = canvas.querySelector('#map-group');
                const targetElement = mapGroup || canvas;
                console.log('[INTRO-ZOOM] elemento objetivo:', targetElement.id || 'canvas');

                // Asegurar que el preloader esté oculto
                const preloader = document.getElementById('preloader');
                if (preloader && preloader.style.display !== 'none') {
                    console.log('[INTRO-ZOOM] preloader aún visible, esperando...');
                    setTimeout(() => triggerIntroZoomFromReferrer(eventType), 200);
                    return;
                }

                const DURATION = 2000; // Más lento para ver claramente
                const INITIAL_SCALE = 1.5; // Mucho más zoom para ser obvio
                const EASING = 'cubic-bezier(.22,.9,.12,1)';

                function doAnim() {
                    if (isAnimating) return;
                    isAnimating = true;
                    lastAnimationTime = Date.now();
                    
                    console.log('[INTRO-ZOOM] ✓ iniciando animación');
                    console.log('[INTRO-ZOOM] targetElement:', {
                        id: targetElement.id,
                        children: targetElement.children.length,
                        transform: targetElement.style.transform,
                        transition: targetElement.style.transition
                    });

                    // CONGELAR handheld-camera inmediatamente (sin animación de regreso)
                    const wasHandheldActive = typeof window.freezeHandheldCamera === 'function';
                    if (wasHandheldActive) {
                        window.freezeHandheldCamera();
                        console.log('[INTRO-ZOOM] handheld-camera congelado');
                    }

                    // Overlay blanco - empieza semi-transparente para ver el zoom
                    const overlay = document.createElement('div');
                    Object.assign(overlay.style, {
                        position: 'fixed',
                        inset: '0',
                        background: '#fff',
                        zIndex: '2147483646',
                        pointerEvents: 'none',
                        opacity: '0.85', // Iniciar semi-transparente para que se vea el mapa
                        transition: `opacity ${DURATION}ms ${EASING}`
                    });
                    document.body.appendChild(overlay);
                    console.log('[INTRO-ZOOM] overlay creado con opacity 0.85');

                    // Detectar origen desde referrer  
                    let originX = '50%', originY = '50%';
                    try {
                        if (document.referrer) {
                            const refUrl = new URL(document.referrer);
                            const file = refUrl.pathname.split('/').pop();
                            if (file) {
                                const selector = `a[href$="${file}"], .image-link[href$="${file}"]`;
                                const target = canvas.querySelector(selector);
                                if (target) {
                                    const elemRect = targetElement.getBoundingClientRect();
                                    const tRect = target.getBoundingClientRect();
                                    const cx = ((tRect.left + tRect.width / 2) - elemRect.left) / elemRect.width * 100;
                                    const cy = ((tRect.top + tRect.height / 2) - elemRect.top) / elemRect.height * 100;
                                    originX = `${Math.min(Math.max(cx, 0), 100)}%`;
                                    originY = `${Math.min(Math.max(cy, 0), 100)}%`;
                                    console.log('[INTRO-ZOOM] origen calculado:', originX, originY);
                                }
                            }
                        }
                    } catch (e) { 
                        console.log('[INTRO-ZOOM] error calculando origen:', e);
                    }

                    // Guardar estilos originales
                    const originalTransition = targetElement.style.transition;
                    const originalTransform = targetElement.style.transform;
                    const originalZIndex = targetElement.style.zIndex;
                    
                    // Reset transform y transition
                    targetElement.style.transform = '';
                    targetElement.style.transition = 'none';
                    // Z-index MUY ALTO para estar sobre el overlay blanco y que se vea el zoom
                    targetElement.style.zIndex = '2147483647';
                    
                    console.log('[INTRO-ZOOM] estilos preparados');
                    
                    // Forzar reflow
                    window.getComputedStyle(targetElement).transform;
                    
                    requestAnimationFrame(() => {
                        targetElement.style.transformOrigin = `${originX} ${originY}`;
                        targetElement.style.willChange = 'transform';
                        // NO aplicar transition aún - queremos que el estado inicial sea instantáneo
                        targetElement.style.transition = 'none';
                        // Aplicar scale inicial (zoom in) SIN TRANSICIÓN
                        targetElement.style.transform = `scale(${INITIAL_SCALE})`;
                        
                        console.log('[INTRO-ZOOM] transform inicial aplicado (sin transition):', targetElement.style.transform);

                        // Forzar render del estado inicial
                        window.getComputedStyle(targetElement).transform;
                        
                        // Paso 1: Empezar el zoom-out PRIMERO
                        requestAnimationFrame(() => {
                            console.log('[INTRO-ZOOM] iniciando zoom out a scale(1)');
                            // Agregar la transition y cambiar a scale(1)
                            targetElement.style.transition = `transform ${DURATION}ms ${EASING}`;
                            targetElement.style.transform = 'scale(1)';
                            
                            // Paso 2: Poco después, empezar a desvanecer el overlay
                            setTimeout(() => {
                                overlay.style.opacity = '0';
                                console.log('[INTRO-ZOOM] overlay comenzando fade-out');
                            }, 50); // El overlay empieza 50ms después del zoom
                        });
                    });

                    // Limpieza y blend con handheld-camera - comenzar antes para solapar
                    setTimeout(() => {
                        if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                        targetElement.style.willChange = 'auto';
                        
                        // Transición más larga y suave de vuelta al estado original
                        targetElement.style.transition = `transform 800ms cubic-bezier(.22,.61,.36,1), z-index 0ms 800ms`;
                        targetElement.style.transform = originalTransform || 'none';
                        targetElement.style.zIndex = originalZIndex;
                        
                        // REACTIVAR handheld-camera inmediatamente para blendear
                        setTimeout(() => {
                            if (wasHandheldActive) {
                                window.resumeHandheldCamera();
                                console.log('[INTRO-ZOOM] handheld-camera reactivado con blend');
                            }
                            
                            // Restaurar transition original después
                            setTimeout(() => {
                                targetElement.style.transition = originalTransition;
                            }, 850);
                        }, 50);
                        
                        isAnimating = false;
                        console.log('[INTRO-ZOOM] ✓ animación finalizada y limpieza completada');
                    }, DURATION - 650); // Comenzar 650ms antes del final para mayor solapamiento
                }

                // Esperar a que el canvas tenga contenido
                if (canvas.children.length > 0 || (mapGroup && mapGroup.children.length > 0)) {
                    console.log('[INTRO-ZOOM] contenido encontrado, ejecutando inmediatamente');
                    doAnim();
                } else {
                    console.log('[INTRO-ZOOM] esperando contenido en canvas...');
                    const mo = new MutationObserver((muts, obs) => {
                        if (canvas.children.length > 0) {
                            console.log('[INTRO-ZOOM] contenido detectado via observer');
                            obs.disconnect();
                            doAnim();
                        }
                    });
                    mo.observe(canvas, { childList: true, subtree: true });
                    setTimeout(() => {
                        try { mo.disconnect(); } catch (e) { }
                        console.log('[INTRO-ZOOM] timeout alcanzado, ejecutando de todas formas');
                        doAnim();
                    }, 2000);
                }
            }

            // Múltiples disparadores para asegurar que funcione
            window.addEventListener('load', () => {
                console.log('[INTRO-ZOOM] evento load disparado');
                triggerIntroZoomFromReferrer('load');
                // Marcar que ya visitaste index.html en esta sesión
                setTimeout(() => {
                    sessionStorage.setItem(sessionKey, '1');
                    console.log('[INTRO-ZOOM] marcado como visitado en sesión');
                }, 500);
            });
            
            // Solo escuchar pageshow si es un retorno (no en el primer load)
            window.addEventListener('pageshow', (e) => {
                console.log('[INTRO-ZOOM] pageshow, persisted:', e.persisted, 'isReturning:', isReturning);
                // Solo ejecutar si NO es la carga inicial (evitar doblar con load)
                if (isReturning) {
                    setTimeout(() => triggerIntroZoomFromReferrer('pageshow'), 150);
                }
            });

            window.addEventListener('popstate', () => {
                console.log('[INTRO-ZOOM] popstate detectado');
                if (isReturning) {
                    setTimeout(() => triggerIntroZoomFromReferrer('popstate'), 150);
                }
            });

            // Exponer para debugging - forzar con window.triggerIntroZoomFromReferrer()
            window.triggerIntroZoomFromReferrer = () => {
                console.log('[INTRO-ZOOM] disparado manualmente desde consola');
                triggerIntroZoomFromReferrer('manual');
            };
        })();
    </script>
</body>
</html>